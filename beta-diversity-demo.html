<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>8 Beta diversity demo | Microbiome data science with R/Bioconductor</title>
  <meta name="description" content="Course material" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="8 Beta diversity demo | Microbiome data science with R/Bioconductor" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Course material" />
  <meta name="github-repo" content="microbiome/course_2022_oulu" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="8 Beta diversity demo | Microbiome data science with R/Bioconductor" />
  
  <meta name="twitter:description" content="Course material" />
  



<meta name="date" content="2022-07-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="alpha-diversity-demo.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Microbiome data science with R/Bioconductor</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#contents-and-learning-goals"><i class="fa fa-check"></i><b>1.1</b> Contents and learning goals</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#schedule-and-organizers"><i class="fa fa-check"></i><b>1.2</b> Schedule and organizers</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i><b>1.3</b> Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="code-of-conduct.html"><a href="code-of-conduct.html"><i class="fa fa-check"></i><b>2</b> Code of Conduct</a></li>
<li class="chapter" data-level="3" data-path="start.html"><a href="start.html"><i class="fa fa-check"></i><b>3</b> Getting started</a>
<ul>
<li class="chapter" data-level="3.1" data-path="start.html"><a href="start.html#checklist-before-the-course"><i class="fa fa-check"></i><b>3.1</b> Checklist (before the course)</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="start.html"><a href="start.html#computer-setup-and-installations"><i class="fa fa-check"></i><b>3.1.1</b> Computer setup and installations</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="start.html"><a href="start.html#support-and-resources"><i class="fa fa-check"></i><b>3.2</b> Support and resources</a></li>
<li class="chapter" data-level="3.3" data-path="start.html"><a href="start.html#packages"><i class="fa fa-check"></i><b>3.3</b> Installing and loading the required R packages</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="importing-microbiome-data.html"><a href="importing-microbiome-data.html"><i class="fa fa-check"></i><b>4</b> Importing microbiome data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="importing-microbiome-data.html"><a href="importing-microbiome-data.html#data-access"><i class="fa fa-check"></i><b>4.1</b> Data access</a></li>
<li class="chapter" data-level="4.2" data-path="importing-microbiome-data.html"><a href="importing-microbiome-data.html#importing-microbiome-data-in-r"><i class="fa fa-check"></i><b>4.2</b> Importing microbiome data in R</a></li>
<li class="chapter" data-level="4.3" data-path="importing-microbiome-data.html"><a href="importing-microbiome-data.html#example-solutions"><i class="fa fa-check"></i><b>4.3</b> Example solutions</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="reproducible-reporting-with-rmarkdown.html"><a href="reproducible-reporting-with-rmarkdown.html"><i class="fa fa-check"></i><b>5</b> Reproducible reporting with Rmarkdown</a></li>
<li class="chapter" data-level="6" data-path="material.html"><a href="material.html"><i class="fa fa-check"></i><b>6</b> Study material</a>
<ul>
<li class="chapter" data-level="6.1" data-path="material.html"><a href="material.html#online-tutorial"><i class="fa fa-check"></i><b>6.1</b> Online tutorial</a></li>
<li class="chapter" data-level="6.2" data-path="material.html"><a href="material.html#lecture-slides"><i class="fa fa-check"></i><b>6.2</b> Lecture slides</a></li>
<li class="chapter" data-level="6.3" data-path="material.html"><a href="material.html#tasks"><i class="fa fa-check"></i><b>6.3</b> Tasks</a></li>
<li class="chapter" data-level="6.4" data-path="material.html"><a href="material.html#extra-material-on-miaverse-and-r-programming"><i class="fa fa-check"></i><b>6.4</b> Extra material on miaverse and R programming</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="alpha-diversity-demo.html"><a href="alpha-diversity-demo.html"><i class="fa fa-check"></i><b>7</b> Alpha diversity demo</a>
<ul>
<li class="chapter" data-level="7.1" data-path="alpha-diversity-demo.html"><a href="alpha-diversity-demo.html#alpha-diversity-estimation"><i class="fa fa-check"></i><b>7.1</b> Alpha diversity estimation</a></li>
<li class="chapter" data-level="7.2" data-path="alpha-diversity-demo.html"><a href="alpha-diversity-demo.html#visualizing-alpha-diversity"><i class="fa fa-check"></i><b>7.2</b> Visualizing alpha diversity</a></li>
<li class="chapter" data-level="7.3" data-path="alpha-diversity-demo.html"><a href="alpha-diversity-demo.html#comparing-alpha-diversity"><i class="fa fa-check"></i><b>7.3</b> Comparing alpha diversity</a></li>
<li class="chapter" data-level="7.4" data-path="alpha-diversity-demo.html"><a href="alpha-diversity-demo.html#exercises"><i class="fa fa-check"></i><b>7.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="beta-diversity-demo.html"><a href="beta-diversity-demo.html"><i class="fa fa-check"></i><b>8</b> Beta diversity demo</a>
<ul>
<li class="chapter" data-level="8.1" data-path="beta-diversity-demo.html"><a href="beta-diversity-demo.html#visualizations"><i class="fa fa-check"></i><b>8.1</b> Visualizations</a></li>
<li class="chapter" data-level="8.2" data-path="beta-diversity-demo.html"><a href="beta-diversity-demo.html#hypothesis-testing"><i class="fa fa-check"></i><b>8.2</b> Hypothesis testing</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="beta-diversity-demo.html"><a href="beta-diversity-demo.html#testing-the-differences-in-dispersion"><i class="fa fa-check"></i><b>8.2.1</b> Testing the differences in dispersion</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="beta-diversity-demo.html"><a href="beta-diversity-demo.html#exercises-1"><i class="fa fa-check"></i><b>8.3</b> Exercises</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Microbiome data science with R/Bioconductor</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="beta-diversity-demo" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">8</span> Beta diversity demo<a href="beta-diversity-demo.html#beta-diversity-demo" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="visualizations" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Visualizations<a href="beta-diversity-demo.html#visualizations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Lets generate ordination plots with different methods and transformations.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="beta-diversity-demo.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### calculating Bray Curtis dissimilarity and PCoA</span></span>
<span id="cb55-2"><a href="beta-diversity-demo.html#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="beta-diversity-demo.html#cb55-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb55-4"><a href="beta-diversity-demo.html#cb55-4" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">method =</span> <span class="st">&quot;bray&quot;</span>, <span class="at">name =</span> <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb55-5"><a href="beta-diversity-demo.html#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="beta-diversity-demo.html#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="beta-diversity-demo.html#cb55-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;patient_status&quot;</span>)</span>
<span id="cb55-8"><a href="beta-diversity-demo.html#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="beta-diversity-demo.html#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add explained variance for each axis</span></span>
<span id="cb55-10"><a href="beta-diversity-demo.html#cb55-10" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">reducedDim</span>(tse, <span class="st">&quot;PCoA_BC&quot;</span>), <span class="st">&quot;eig&quot;</span>);</span>
<span id="cb55-11"><a href="beta-diversity-demo.html#cb55-11" aria-hidden="true" tabindex="-1"></a>rel_eig <span class="ot">&lt;-</span> e<span class="sc">/</span><span class="fu">sum</span>(e[e<span class="sc">&gt;</span><span class="dv">0</span>])          </span>
<span id="cb55-12"><a href="beta-diversity-demo.html#cb55-12" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">paste</span>(<span class="st">&quot;PCoA 1 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">1</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb55-13"><a href="beta-diversity-demo.html#cb55-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> <span class="fu">paste</span>(<span class="st">&quot;PCoA 2 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">2</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb55-14"><a href="beta-diversity-demo.html#cb55-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-15"><a href="beta-diversity-demo.html#cb55-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/viz1-1.png" width="672" /></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="beta-diversity-demo.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Aitchinson distances and PCA</span></span>
<span id="cb56-2"><a href="beta-diversity-demo.html#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="beta-diversity-demo.html#cb56-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse, <span class="at">method =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">pseudocount =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## Warning: All the total abundances of samples do not sum-up to a fixed constant.
## Please consider to apply, e.g., relative transformation in prior to CLR
## transformation.</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="beta-diversity-demo.html#cb58-1" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">name =</span> <span class="st">&quot;MDS_euclidean&quot;</span>,</span>
<span id="cb58-2"><a href="beta-diversity-demo.html#cb58-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">&quot;euclidean&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;clr&quot;</span>)</span>
<span id="cb58-3"><a href="beta-diversity-demo.html#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="beta-diversity-demo.html#cb58-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;MDS_euclidean&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;patient_status_vs_cohort&quot;</span>)</span>
<span id="cb58-5"><a href="beta-diversity-demo.html#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="beta-diversity-demo.html#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add explained variance for each axis</span></span>
<span id="cb58-7"><a href="beta-diversity-demo.html#cb58-7" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">reducedDim</span>(tse, <span class="st">&quot;MDS_euclidean&quot;</span>), <span class="st">&quot;eig&quot;</span>);</span>
<span id="cb58-8"><a href="beta-diversity-demo.html#cb58-8" aria-hidden="true" tabindex="-1"></a>rel_eig <span class="ot">&lt;-</span> e<span class="sc">/</span><span class="fu">sum</span>(e[e<span class="sc">&gt;</span><span class="dv">0</span>])          </span>
<span id="cb58-9"><a href="beta-diversity-demo.html#cb58-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">paste</span>(<span class="st">&quot;Axis 1 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">1</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb58-10"><a href="beta-diversity-demo.html#cb58-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> <span class="fu">paste</span>(<span class="st">&quot;Axis 2 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">2</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb58-11"><a href="beta-diversity-demo.html#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="beta-diversity-demo.html#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/viz1-2.png" width="672" /></p>
<p>PCA is a subtype of MDS with Euclidean distances, below is a different alternative for running the same analysis.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="beta-diversity-demo.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># alternative method </span></span>
<span id="cb59-2"><a href="beta-diversity-demo.html#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="beta-diversity-demo.html#cb59-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(tse, <span class="at">name =</span> <span class="st">&quot;PCA&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">ncomponents =</span> <span class="dv">10</span>)</span>
<span id="cb59-4"><a href="beta-diversity-demo.html#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;PCA&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;patient_status_vs_cohort&quot;</span>)</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/viz2-1.png" width="672" /></p>
<p>One can use also ggplot for ordination plots for the flexible adaptablity.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="beta-diversity-demo.html#cb60-1" aria-hidden="true" tabindex="-1"></a>dis <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">vegdist</span>(<span class="fu">t</span>(<span class="fu">assays</span>(tse)<span class="sc">$</span>counts), <span class="at">method =</span> <span class="st">&quot;jaccard&quot;</span>)</span>
<span id="cb60-2"><a href="beta-diversity-demo.html#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="beta-diversity-demo.html#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># principal coordinate analysis</span></span>
<span id="cb60-4"><a href="beta-diversity-demo.html#cb60-4" aria-hidden="true" tabindex="-1"></a>jaccard_pcoa <span class="ot">&lt;-</span> ecodist<span class="sc">::</span><span class="fu">pco</span>(dis)</span>
<span id="cb60-5"><a href="beta-diversity-demo.html#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="beta-diversity-demo.html#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co"># a data frame from principal coordinates and groupng variable</span></span>
<span id="cb60-7"><a href="beta-diversity-demo.html#cb60-7" aria-hidden="true" tabindex="-1"></a>jaccard_pcoa_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">pcoa1 =</span> jaccard_pcoa<span class="sc">$</span>vectors[,<span class="dv">1</span>], </span>
<span id="cb60-8"><a href="beta-diversity-demo.html#cb60-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">pcoa2 =</span> jaccard_pcoa<span class="sc">$</span>vectors[,<span class="dv">2</span>],</span>
<span id="cb60-9"><a href="beta-diversity-demo.html#cb60-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">patient_status_vs_cohort =</span>  <span class="fu">colData</span>(tse)<span class="sc">$</span>patient_status_vs_cohort)</span>
<span id="cb60-10"><a href="beta-diversity-demo.html#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="beta-diversity-demo.html#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="beta-diversity-demo.html#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb60-13"><a href="beta-diversity-demo.html#cb60-13" aria-hidden="true" tabindex="-1"></a>jaccard_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> jaccard_pcoa_df, <span class="fu">aes</span>(<span class="at">x=</span>pcoa1, <span class="at">y=</span>pcoa2, <span class="at">color =</span> patient_status_vs_cohort)) <span class="sc">+</span></span>
<span id="cb60-14"><a href="beta-diversity-demo.html#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb60-15"><a href="beta-diversity-demo.html#cb60-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">paste</span>(<span class="st">&quot;Axis 1 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> jaccard_pcoa<span class="sc">$</span>values[[<span class="dv">1</span>]] <span class="sc">/</span> <span class="fu">sum</span>(jaccard_pcoa<span class="sc">$</span>values), <span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb60-16"><a href="beta-diversity-demo.html#cb60-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">paste</span>(<span class="st">&quot;Axis 2 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> jaccard_pcoa<span class="sc">$</span>values[[<span class="dv">2</span>]] <span class="sc">/</span> <span class="fu">sum</span>(jaccard_pcoa<span class="sc">$</span>values), <span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb60-17"><a href="beta-diversity-demo.html#cb60-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Jaccard PCoA&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-18"><a href="beta-diversity-demo.html#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb60-19"><a href="beta-diversity-demo.html#cb60-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb60-20"><a href="beta-diversity-demo.html#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="beta-diversity-demo.html#cb60-21" aria-hidden="true" tabindex="-1"></a>jaccard_plot</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/viz%20ggplot-1.png" width="672" /></p>
</div>
<div id="hypothesis-testing" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Hypothesis testing<a href="beta-diversity-demo.html#hypothesis-testing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>PERMANOVA with the function adonis is most commonly used to detect differences in multivariate data.
adonis function was recently updated with slightly different functionality. Now the adonis2 allows independent analysis of terms.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="beta-diversity-demo.html#cb61-1" aria-hidden="true" tabindex="-1"></a>variable_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;patient_status&quot;</span>, <span class="st">&quot;cohort&quot;</span>)</span>
<span id="cb61-2"><a href="beta-diversity-demo.html#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="beta-diversity-demo.html#cb61-3" aria-hidden="true" tabindex="-1"></a>tse_genus <span class="ot">&lt;-</span> <span class="fu">agglomerateByRank</span>(tse, <span class="st">&quot;Genus&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: &#39;clr&#39; includes negative values.
## Agglomeration of it might lead to meaningless values.
## Check the assay, and consider doing transformation again manually with agglomerated data.</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="beta-diversity-demo.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply relative transform</span></span>
<span id="cb63-2"><a href="beta-diversity-demo.html#cb63-2" aria-hidden="true" tabindex="-1"></a>tse_genus <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse_genus, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb63-3"><a href="beta-diversity-demo.html#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="beta-diversity-demo.html#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="beta-diversity-demo.html#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12346</span>)</span>
<span id="cb63-6"><a href="beta-diversity-demo.html#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We choose 99 random permutations for speed. Consider applying more (999 or 9999) </span></span>
<span id="cb63-7"><a href="beta-diversity-demo.html#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="beta-diversity-demo.html#cb63-8" aria-hidden="true" tabindex="-1"></a>assay <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">assay</span>(tse_genus,<span class="st">&quot;relabundance&quot;</span>))</span>
<span id="cb63-9"><a href="beta-diversity-demo.html#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="beta-diversity-demo.html#cb63-10" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;assay ~&quot;</span>, <span class="fu">paste</span>(variable_names, <span class="at">collapse=</span><span class="st">&quot;+&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">as.formula</span>()</span>
<span id="cb63-11"><a href="beta-diversity-demo.html#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="beta-diversity-demo.html#cb63-12" aria-hidden="true" tabindex="-1"></a>permanova2 <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">adonis2</span>(mod,</span>
<span id="cb63-13"><a href="beta-diversity-demo.html#cb63-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">by =</span> <span class="st">&quot;margin&quot;</span>, <span class="co"># each term analyzed individually</span></span>
<span id="cb63-14"><a href="beta-diversity-demo.html#cb63-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> <span class="fu">colData</span>(tse),</span>
<span id="cb63-15"><a href="beta-diversity-demo.html#cb63-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">&quot;bray&quot;</span>,</span>
<span id="cb63-16"><a href="beta-diversity-demo.html#cb63-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">permutations =</span> <span class="dv">99</span>)</span>
<span id="cb63-17"><a href="beta-diversity-demo.html#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="beta-diversity-demo.html#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(permanova2)</span></code></pre></div>
<pre><code>## Permutation test for adonis under reduced model
## Marginal effects of terms
## Permutation: free
## Number of permutations: 99
## 
## vegan::adonis2(formula = mod, data = colData(tse), permutations = 99, method = &quot;bray&quot;, by = &quot;margin&quot;)
##                Df SumOfSqs      R2     F Pr(&gt;F)
## patient_status  1   0.1885 0.05817 1.490   0.23
## cohort          2   0.1450 0.04474 0.573   0.75
## Residual       23   2.9104 0.89787             
## Total          26   3.2414 1.00000</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="beta-diversity-demo.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># older adonis for reference</span></span>
<span id="cb65-2"><a href="beta-diversity-demo.html#cb65-2" aria-hidden="true" tabindex="-1"></a>permanova <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">adonis</span>(mod,</span>
<span id="cb65-3"><a href="beta-diversity-demo.html#cb65-3" aria-hidden="true" tabindex="-1"></a>                            <span class="co">#by = &quot;margin&quot;, # each term analyzed sequentially</span></span>
<span id="cb65-4"><a href="beta-diversity-demo.html#cb65-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">data =</span> <span class="fu">colData</span>(tse),</span>
<span id="cb65-5"><a href="beta-diversity-demo.html#cb65-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">method =</span> <span class="st">&quot;bray&quot;</span>,</span>
<span id="cb65-6"><a href="beta-diversity-demo.html#cb65-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">permutations =</span> <span class="dv">99</span>)</span></code></pre></div>
<pre><code>## &#39;adonis&#39; will be deprecated: use &#39;adonis2&#39; instead</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="beta-diversity-demo.html#cb67-1" aria-hidden="true" tabindex="-1"></a>permanova<span class="sc">$</span>aov.tab</span></code></pre></div>
<pre><code>## Permutation: free
## Number of permutations: 99
## 
## Terms added sequentially (first to last)
## 
##                Df SumsOfSqs  MeanSqs F.Model      R2 Pr(&gt;F)
## patient_status  1    0.1860 0.186024 1.47011 0.05739   0.22
## cohort          2    0.1450 0.072503 0.57298 0.04474   0.79
## Residuals      23    2.9104 0.126537         0.89787       
## Total          26    3.2414                  1.00000</code></pre>
<p>With older adonis version one cam calculate top coefficients driving the differences between groups.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="beta-diversity-demo.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># older adonis supplies the coefficients</span></span>
<span id="cb69-2"><a href="beta-diversity-demo.html#cb69-2" aria-hidden="true" tabindex="-1"></a>coef <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(permanova)[<span class="st">&quot;cohort1&quot;</span>,]</span>
<span id="cb69-3"><a href="beta-diversity-demo.html#cb69-3" aria-hidden="true" tabindex="-1"></a>top.coef <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">head</span>(coef[<span class="fu">rev</span>(<span class="fu">order</span>(<span class="fu">abs</span>(coef)))],<span class="dv">20</span>))</span>
<span id="cb69-4"><a href="beta-diversity-demo.html#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="beta-diversity-demo.html#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot </span></span>
<span id="cb69-6"><a href="beta-diversity-demo.html#cb69-6" aria-hidden="true" tabindex="-1"></a>top_taxa_coeffient_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> top.coef,</span>
<span id="cb69-7"><a href="beta-diversity-demo.html#cb69-7" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">y =</span> <span class="fu">factor</span>(<span class="fu">names</span>(top.coef),</span>
<span id="cb69-8"><a href="beta-diversity-demo.html#cb69-8" aria-hidden="true" tabindex="-1"></a>                                                        <span class="fu">unique</span>(<span class="fu">names</span>(top.coef)))),</span>
<span id="cb69-9"><a href="beta-diversity-demo.html#cb69-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb69-10"><a href="beta-diversity-demo.html#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-11"><a href="beta-diversity-demo.html#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">title=</span><span class="st">&quot;Top Taxa&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-12"><a href="beta-diversity-demo.html#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb69-13"><a href="beta-diversity-demo.html#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="beta-diversity-demo.html#cb69-14" aria-hidden="true" tabindex="-1"></a>top_taxa_coeffient_plot</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/permanova%20coef-1.png" width="672" /></p>
<div id="testing-the-differences-in-dispersion" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Testing the differences in dispersion<a href="beta-diversity-demo.html#testing-the-differences-in-dispersion" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>PEMRANOVA doesn’t differentiate between different within-group variation, i.e. dispersion, or the mean differences between groups, i.e. the location of the centroid.
Follow-up testing can be done with PERMDISP2 implemented in the vegan package.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="beta-diversity-demo.html#cb70-1" aria-hidden="true" tabindex="-1"></a>dis <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">vegdist</span>(<span class="fu">t</span>(<span class="fu">assays</span>(tse)<span class="sc">$</span>counts), <span class="at">method =</span> <span class="st">&quot;bray&quot;</span>)</span>
<span id="cb70-2"><a href="beta-diversity-demo.html#cb70-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">betadisper</span>(dis, <span class="fu">colData</span>(tse)<span class="sc">$</span>cohort)</span>
<span id="cb70-3"><a href="beta-diversity-demo.html#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">anova</span>(b))</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: Distances
##           Df   Sum Sq   Mean Sq F value Pr(&gt;F)
## Groups     2 0.000375 0.0001875  0.0166 0.9835
## Residuals 24 0.270795 0.0112831</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="beta-diversity-demo.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boxplor for distances to centroid</span></span>
<span id="cb72-2"><a href="beta-diversity-demo.html#cb72-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">distance =</span> <span class="fu">as.numeric</span>(b<span class="sc">$</span>distances),</span>
<span id="cb72-3"><a href="beta-diversity-demo.html#cb72-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">cohort =</span> <span class="fu">colData</span>(tse)<span class="sc">$</span>cohort) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="beta-diversity-demo.html#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-5"><a href="beta-diversity-demo.html#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">distance =</span> <span class="fu">as.numeric</span>(distance)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-6"><a href="beta-diversity-demo.html#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(cohort, distance)) <span class="sc">+</span> </span>
<span id="cb72-7"><a href="beta-diversity-demo.html#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb72-8"><a href="beta-diversity-demo.html#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb72-9"><a href="beta-diversity-demo.html#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="beta-diversity-demo.html#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<p><img src="06-beta_diversity_demo_files/figure-html/dispersion-1.png" width="672" /></p>
<p>End of the demo.</p>
</div>
</div>
<div id="exercises-1" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Exercises<a href="beta-diversity-demo.html#exercises-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Do “Beta diversity” from the <a href="https://microbiome.github.io/OMA/exercises.html">exercises</a>.</p>

<div id="refs" class="references csl-bib-body hanging-indent">
<div class="csl-entry">
Borman, Tuomas, Henrik Eckerman, Anna Aatsinki, and Leo Lahti. 2022. <em>Microbiome Data Science with r/Bioconductor. Radboud Summer School.</em> <a href="https://microbiome.github.io/course_2022_radboud">microbiome.github.io/course_2022_radboud</a>.
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="alpha-diversity-demo.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["oulu2022_material.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
